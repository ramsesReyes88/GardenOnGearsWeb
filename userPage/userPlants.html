<!DOCTYPE html>
<html lang="en">
<head>
    <title>GardenOnGears PlantCare</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="/mygauge/justgage/raphael-2.1.4.min.js"></script>
    <script src="/mygauge/justgage/justgage.js"></script>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"></link>
    <script src="https://code.highcharts.com/highcharts.js"></script> 
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
    <script src="http://code.highcharts.com/stock/highstock.js"></script>
    <script src="http://code.highcharts.com/stock/modules/exporting.js"></script> 
    <link rel="shortcut icon" type="image/x-icon" href="assets/img/favicon.ico">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="../assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/css/templatemo.css">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="stylesheet" href="../assets/css/usercss/plants.css">
    <link rel="stylesheet" href="../assets/css/usercss/usercss.css">
    <link rel="stylesheet" href="../assets/css/usercss/chartsStyles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;200;300;400;500;700;900&display=swap">
    <link rel="stylesheet" href="../assets/css/fontawesome.min.css">

</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light shadow">
        <div class="container d-flex justify-content-between align-items-center">
            <a class="navbar-brand text-success logo h1 align-self-center" href="index.html">
                <img class="gog-logo" src="../assets/img/apple-icon.png">   
            </a>
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#templatemo_main_nav" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="align-self-center collapse navbar-collapse flex-fill d-lg-flex justify-content-lg-between" id="templatemo_main_nav">
                <div class="flex-fill">
                    <ul class="nav navbar-nav d-flex justify-content-between mx-lg-auto">
                        <li class="nav-item"><a class="nav-link" href="../index.html">Home</a></li>
                        <li class="nav-item"><a class="nav-link" href="../shop.html">Shop</a></li>
                        <li class="nav-item"><a id="linkPlantas" class="nav-link" href="./userPlants.html">Plantas</a></li>
                    </ul>
                </div>
                <div class="navbar align-self-center d-flex">
                    <a id="linkLogout" class="nav-icon position-relative text-decoration-none" href="#" onclick="logout()">
                        <i class="fa fa-fw fa-sign-out-alt text-dark mr-4"></i>
                    </a>
                    <a id="linkPerfil" class="nav-icon position-relative text-decoration-none" href="../profile.html">
                        <i class="fa fa-fw fa-user text-dark mr-3"></i>
                    </a>
                    <a class="nav-icon position-relative text-decoration-none" href="../carrito.html">
                        <i class="fa fa-fw fa-cart-arrow-down text-dark mr-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    
    

    <div class="cards-container">
        <div class="plant-card">
            <div class="upload-container">
                <div class="pic-container">
                    <img id="plantImage" class="profile-img">
                    <div class="changePicture">
                        <input type="file" id="plantImageUpload" accept="image/*" style="display:none">
                        <i class="iconProfile fa fa-folder-plus" onclick="document.getElementById('plantImageUpload').click();"></i>
                    </div>
                    
                </div>
            </div>
            <span id="uploadImageBtn" cursor = "pointer">
                <i class="iconUpload fa fa-upload">
                    Upload Image
                </i>
            </span>
            <br>
            <h3>Planta:</h3>
            <p><strong>Nombre:</strong> <span id="plantName"></span></p>
            <p><strong>Descripcion de Cuidados:</strong> <span id="plantDescription"></span></p>
            <p><strong>Cantidad Riego Requerido:</strong> <span id="plantWatering"></span></p>
            <p><strong>Fecha Plantado:</strong> <span id="plantDate"></span></p>

            <h3>Jardín:</h3>
            <p><strong>Nombre del Jardín:</strong> <span id="gardenName"></span></p>
            <p><strong>Ubicación del Jardín:</strong> <span id="gardenLocation"></span></p>
        </div>
    </div>




        

    <div class = "dataContainer">
        <h3 align = "center">Tus datos registrados</h3>
        <!-- Start Normal Counter -->
        <table style="width: 100%">
            <tr>
            <td style ="width: 17%">
                <div class = "container mt-5">
                    <div class = "cardTemp">
                        <div class = "card-body">
                            <h5 class="card-title">Temperatura</h5>
                            <div class="temperature" id="temperature"></div>
                        </div>
                    </div>
                </div>
            </td>
            <td style ="width: 17%">
                <div class = "container2 mt-5">
                    <div class = "cardHum">
                        <div class = "card-body">
                            <h5 class="card-title">Humedad</h5>
                            <div class="humidity" id="humidity"></div>
                        </div>
                    </div>
                </div>
            </td>
            <td style ="width: 17%">
                <div class = "container3 mt-5">
                    <div class = "cardLux">
                        <div class = "card-body">
                            <h5 class="card-title">Luminosidad</h5>
                            <div class="luminosity" id="luminosity"></div>
                        </div>
                    </div>
                </div>
            </td>
            <td style="width: 16%"></td>
            <td style="width: 16%"></td>
            <td style="width: 16%"></td>
            <td style="width: 16%"></td>
            <td style="width: 16%"></td>
            <td style="width: 16%"></td>
        </table>
        <script>
            function updateValues(){
                $.getJSON("http://localhost:8000/0322103800/getValue",function(response){
                    var temperature = response.data.temperature;
                    var humidity = response.data.RH;
                    var luminosity = response.data.lux;
        
                    $('#temperature').text(temperature + ' °C');
                    $('#humidity').text(humidity + ' %');  
                    $('#luminosity').text(luminosity + ' %');
                });
            }
            updateValues();
            setInterval(updateValues,5000);
        </script>
        <!-- End Normal Counter -->
        <!-- Start Gage -->
        <div class="gauge-container">
            <div id="temperature_gauge" class="gauge" style="width:400px; height:320px"></div>
            <div id="humidity_gauge" class="gauge" style="width:400px; height:320px"></div>
            <div id="luminosity_gauge" class="gauge" style="width:350px; height:320px"></div>
        </div>
    
        <script>
            var gauge_temp;
            var gauge_hum;
            var gauge_lux;
    
            function initGauge() {
                gauge_temp = new JustGage({
                    id: "temperature_gauge",
                    value: 0,
                    min: 0,
                    max: 50,
                    title: "Temperatura",
                    levelColors: ["#0000FF"],
                    label: "°C"
                });
                gauge_hum = new JustGage({
                    id: "humidity_gauge",
                    value: 0,
                    min: 0,
                    max: 100,
                    title: "Humedad Relativa",
                    levelColors: ["#00FF00"],
                    label: "%"
                });
                gauge_lux = new JustGage({
                    id: "luminosity_gauge",
                    value: 0,
                    min: 0,
                    max: 4095,
                    title: "Luminosidad",
                    levelColors: ["#FF0000"],
                    label: "%"
                });
            }
    
            function updateGauge(temperature, humidity, luminosity) {
                gauge_temp.refresh(temperature);
                gauge_hum.refresh(humidity);
                gauge_lux.refresh(luminosity);
            }
    
            function updateValues() {
               
                $.getJSON('http://localhost:8000/0322103800/getValue', function(response) {
                    var temperature = response.data.temperature;
                    var humidity = response.data.RH;
                    var luminosity = response.data.lux;
                    console.log("Temperature = " + temperature);
                    console.log("Humidity = " + humidity);
                    console.log("Luminosity = " + luminosity);
                    
                    $('#temperature').text(temperature + ' °C');
                    $('#humidity').text(humidity + ' %');
                    $('#luminosity').text(luminosity + ' %');
                    updateGauge(temperature, humidity,luminosity);
                    
                });
            }
    
            $(document).ready(function() {
                initGauge();
                updateValues();
                setInterval(updateValues, 5000);
            });
        </script>
        <!-- End Gage -->
         <!-- Start Highchart -->
        <div class="charts-container">
            <div id="temperature_chart"></div>
            <div id="humidity_chart"></div>
            <div id="luminosity_chart"></div>
        </div>
        <script>
            function createChart(container, titleText, yAxisTitle, seriesName) {
                return Highcharts.chart(container, {
                    chart: {
                        reflow: true,
                        type: 'spline'
                    },
                    title: {
                        text:  titleText
                    },
                    subtitle: {
                        text: 'Data input from JSON API'
                    },
                    xAxis: {
                        type: 'datetime',
                        title: {
                            text: 'Tiempo'
                        }
                    },
                    yAxis: {
                        title: {
                            text: yAxisTitle
                        }
                    },
                    series: [{
                        name: seriesName,
                        data: [],
                        enablePolling: true
                    }]
                });
            }
        
            var temperatureChart = createChart('temperature_chart', 'Temperatura', 'Celsius', 'Temperatura');
            var humidityChart = createChart('humidity_chart', 'Humedad', '%', 'Humedad');
            var luminosityChart = createChart('luminosity_chart', 'Luminosidad', '%', 'Luminosidad');
        
            function updateCharts() {
                $.getJSON('http://localhost:8000/0322103800/singleValues', function(response) {
                    var data = response.data;
                    console.log('Received data:', data);
        
                    if (data.length > 0) {
                        var timestamp = Date.parse(data[0][0]);
                        var temperature = data[0][1];
                        var humidity = data[0][2];
                        var luminosity = data[0][3];
        
                        console.log('Timestamp:', timestamp);
                        console.log('Temperature:', temperature);
                        console.log('Humidity:', humidity);
                        console.log('Luminosity:', luminosity);
        
                        console.log('Adding point to temperature chart:', [timestamp, temperature]);
                        console.log('Adding point to humidity chart:', [timestamp, humidity]);
                        console.log('Adding point to luminosity chart:', [timestamp, luminosity]);
        
                        temperatureChart.series[0].addPoint([timestamp, temperature], true, false);
                        humidityChart.series[0].addPoint([timestamp, humidity], true, false);
                        luminosityChart.series[0].addPoint([timestamp, luminosity], true, false);

                        temperatureChart.series[0].update({ color: '#0000FF' }); 
                        humidityChart.series[0].update({ color: '#00FF00' });   
                        luminosityChart.series[0].update({ color: '#FF0000' }); 
        
                        temperatureChart.redraw();
                        humidityChart.redraw();
                        luminosityChart.redraw();
                    } else {
                        console.log('No data received from API.');
                    }
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    console.error('Error fetching data:', textStatus, errorThrown);
                });
            }
        
            updateCharts();
        
            setInterval(updateCharts, 5000);
        </script>
         <div class="charts-container">
            <div id="temperature_chart"></div>
            <div id="humidity_chart"></div>
            <div id="luminosity_chart"></div>
        </div>
            <script>
                function createChart(container, titleText, yAxisTitle, seriesName) {
                    return Highcharts.chart(container, {
                        chart: {
                            reflow: true,
                            type: 'spline'
                        },
                        title: {
                            text:  titleText
                        },
                        subtitle: {
                            text: 'Data input from JSON API'
                        },
                        xAxis: {
                            type: 'datetime',
                            title: {
                                text: 'Tiempo'
                            }
                        },
                        yAxis: {
                            title: {
                                text: yAxisTitle
                            }
                        },
                        series: [{
                            name: seriesName,
                            data: [],
                            enablePolling: true
                        }]
                    });
                }
            
                var temperatureChart = createChart('temperature_chart', 'Temperatura', 'Celsius', 'Temperatura');
                var humidityChart = createChart('humidity_chart', 'Humedad', '%', 'Humedad');
                var luminosityChart = createChart('luminosity_chart', 'Luminosidad', '%', 'Luminosidad');
            
                function updateCharts() {
                    $.getJSON('http://localhost:8000/0322103800/singleValues', function(response) {
                        var data = response.data;
                        console.log('Received data:', data);
            
                        if (data.length > 0) {
                            var timestamp = Date.parse(data[0][0]);
                            var temperature = data[0][1];
                            var humidity = data[0][2];
                            var luminosity = data[0][3];
            
                            console.log('Timestamp:', timestamp);
                            console.log('Temperature:', temperature);
                            console.log('Humidity:', humidity);
                            console.log('Luminosity:', luminosity);
            
                            console.log('Adding point to temperature chart:', [timestamp, temperature]);
                            console.log('Adding point to humidity chart:', [timestamp, humidity]);
                            console.log('Adding point to luminosity chart:', [timestamp, luminosity]);
            
                            temperatureChart.series[0].addPoint([timestamp, temperature], true, false);
                            humidityChart.series[0].addPoint([timestamp, humidity], true, false);
                            luminosityChart.series[0].addPoint([timestamp, luminosity], true, false);
    
                            temperatureChart.series[0].update({ color: '#0000FF' }); 
                            humidityChart.series[0].update({ color: '#00FF00' });   
                            luminosityChart.series[0].update({ color: '#FF0000' }); 
            
                            temperatureChart.redraw();
                            humidityChart.redraw();
                            luminosityChart.redraw();
                        } else {
                            console.log('No data received from API.');
                        }
                    }).fail(function(jqXHR, textStatus, errorThrown) {
                        console.error('Error fetching data:', textStatus, errorThrown);
                    });
                }
                updateCharts();
                setInterval(updateCharts, 5000);
            </script>
    </div>

    <script>
        $(document).ready(function() {
            var userToken = localStorage.getItem('userToken');
            if (userToken) {
                $.ajax({
                    url: 'https://localhost:44313/api/Jardines/usuario/' + userToken,
                    type: 'GET',
                    success: function(jardinesResponse) {
                        if (jardinesResponse && jardinesResponse.length > 0) {
                            var jardinesIds = jardinesResponse.map(jardin => jardin.id);
                            var jardin = jardinesResponse[0]; // Assuming the first garden is the relevant one

                            // Display garden information
                            $('#gardenName').text(jardin.nombre);
                            $('#gardenLocation').text(jardin.ubicacion);

                            $.ajax({
                                url: 'https://localhost:44313/api/Plantas/jardines',
                                type: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify(jardinesIds),
                                success: function(plantasResponse) {
                                    if (plantasResponse && plantasResponse.length > 0) {
                                        var planta = plantasResponse[0]; // Display the first plant as an example
                                        $('#plantName').text(planta.nombre);
                                        $('#plantDescription').text(planta.descripcion);
                                        $('#plantWatering').text(planta.cantRiegoRequerido + ' veces al Día');
                                        $('#plantDate').text(new Date(planta.fechaPlantado).toLocaleDateString());

                                        // Display image if exists
                                        if (planta.foto) {
                                            $('#plantImage').attr('src', 'data:image/jpeg;base64,' + planta.foto);
                                        }

                                        // Set the plantId for the image upload
                                        $('#uploadImageBtn').data('plant-id', planta.id);
                                    }
                                },
                                error: function(jqXHR, textStatus, errorThrown) {
                                    console.error("Error al obtener información de las plantas:", jqXHR.responseText);
                                    alert("Error al obtener información de las plantas: " + jqXHR.responseText);
                                }
                            });
                        } else {
                            alert("No se encontró información de los jardines.");
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error("Error al obtener información de los jardines:", jqXHR.responseText);
                        alert("Error al obtener información de los jardines: " + jqXHR.responseText);
                    }
                });
            } else {
                alert("Usuario no autenticado.");
                window.location.href = '../index.html';
            }

            $('#uploadImageBtn').click(function() {
                var fileInput = $('#plantImageUpload')[0];
                var plantId = $(this).data('plant-id');
                if (fileInput.files.length > 0 && plantId) {
                    var file = fileInput.files[0];
                    var formData = new FormData();
                    formData.append('image', file);
                    formData.append('plantId', plantId);

                    $.ajax({
                        url: 'https://localhost:44313/api/Plantas/uploadImage',
                        type: 'POST',
                        data: formData,
                        contentType: false,
                        processData: false,
                        success: function(response) {
                            alert("Imagen subida correctamente");
                            $('#plantImage').attr('src', 'data:image/jpeg;base64,' + response.image);
                        },
                        error: function(jqXHR, textStatus, errorThrown) {
                            console.error("Error al subir la imagen:", jqXHR.responseText);
                            alert("Error al subir la imagen: " + jqXHR.responseText);
                        }
                    });
                } else {
                    alert("No se ha seleccionado una imagen o la planta no está definida.");
                }
            });
        });

        function logout() {
            localStorage.removeItem('userToken');
            localStorage.removeItem('nombreUsuario');
            alert("Sesión cerrada correctamente");
            window.location.href = '../index.html';
        }
    </script>
</body>
</html>
